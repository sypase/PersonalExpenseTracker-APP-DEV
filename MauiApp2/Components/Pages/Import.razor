@page "/import"

@using MauiApp2.Data.Service
@inject FileUploadService FileUploadService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Components.Forms
@using MauiApp2.Data.Models
@using MudBlazor

<PageTitle>Import/Export</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Align="Align.Center">Import Transactions from CSV</MudText>

    <MudPaper Class="pa-4" MaxWidth="MaxWidth.Small" AlignItems="Align.Center">
        <MudText Typo="Typo.subtitle1">Upload your CSV file to import transactions.</MudText>

        <!-- Use Blazor InputFile component -->
        <InputFile OnChange="OnFileChange" Accept=".csv" />

        @if (isProcessing)
        {
            <MudLinearProgress Indeterminate="true" />
            <MudText Typo="Typo.body2">Processing the file...</MudText>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudText Color="Color.Error" Typo="Typo.body2">@errorMessage</MudText>
        }

        <MudButton OnClick="SubmitFile" Color="Color.Primary">Submit</MudButton>

        @if (importedTransactions.Any())
        {
            <MudText Typo="Typo.h6">Imported Transactions</MudText>
            <MudTable Items="importedTransactions" Bordered="true" Hover="true">
                <HeaderContent>
                    <MudTh>Title</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Date</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Tags</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Title</MudTd>
                    <MudTd>@context.Amount</MudTd>
                    <MudTd>@(context.Date.HasValue ? context.Date.Value.ToString("MM/dd/yyyy") : "N/A")</MudTd>
                    <MudTd>@context.Type</MudTd>
                    <MudTd>@string.Join(", ", context.Tags)</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<Transaction> importedTransactions = new List<Transaction>();
    private bool isProcessing = false;
    private string errorMessage;
    private string currentUsername;
    private IBrowserFile selectedFile;

    // Fetch current username from localStorage when the page initializes
    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUsername = await JS.InvokeAsync<string>("localStorage.getItem", "currentUser");
            if (string.IsNullOrEmpty(currentUsername))
            {
                errorMessage = "User is not logged in.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error retrieving username: {ex.Message}";
        }
    }

    // Triggered when a file is selected
    private void OnFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile == null)
        {
            errorMessage = "No file selected!";
        }
    }

    // Method to handle file submission
    private async Task SubmitFile()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file first!";
            return;
        }

        try
        {
            isProcessing = true;
            errorMessage = null;

            if (string.IsNullOrEmpty(currentUsername))
            {
                errorMessage = "Username not found!";
                return;
            }

            // Call the FileUploadService to process the CSV file with the current username
            importedTransactions = await FileUploadService.ProcessCsvFileAsync(selectedFile, currentUsername);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading file: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}
